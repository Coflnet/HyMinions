extends ../layouts/default

block append js
    script(src="/js/jquery/jquery.doubleScroll.js")
    script(src="/js/minionsCost.js")
    	
block append variables
    - var currentPage = "minionsCost";

block meta
    meta(name="description" content="Know your most profitable minions! Tailor made for each profile, fully accurate.")

mixin slotRow(nextIndex,isShown,isLoaded)
    tr
    td &nbsp;
    td(colspan="100%")
        if nextIndex+1 == settings.minionSlotsNext.length
            span Remaining minions: #{settings.minionSlotsCostText[nextIndex]} coins &nbsp; &nbsp;
        else if settings.minionSlots+nextIndex == 1 || settings.minionSlots+nextIndex == 21
            span #{settings.minionSlots+nextIndex}st slot: #{settings.minionSlotsCostText[nextIndex]} coins &nbsp; &nbsp;
        else if settings.minionSlots+nextIndex == 2 || settings.minionSlots+nextIndex == 22
            span #{settings.minionSlots+nextIndex}nd slot: #{settings.minionSlotsCostText[nextIndex]} coins &nbsp; &nbsp;
        else if settings.minionSlots+nextIndex == 3 || settings.minionSlots+nextIndex == 23
            span #{settings.minionSlots+nextIndex}rd slot: #{settings.minionSlotsCostText[nextIndex]} coins &nbsp; &nbsp;
        else
            span #{settings.minionSlots+nextIndex}th slot: #{settings.minionSlotsCostText[nextIndex]} coins &nbsp; &nbsp;
        if isLoaded == true 
            if isShown == true
                button.btn.btn-blue(id="showNextButton"+nextIndex onclick="showCollapseNext("+nextIndex+")").d-none Show
                button.btn.btn-blue(id="hideNextButton"+nextIndex onclick="hideCollapseNext("+nextIndex+")") Hide
            else
                button.btn.btn-blue(id="showNextButton"+nextIndex onclick="showCollapseNext("+nextIndex+")") Show
                button.btn.btn-blue(id="hideNextButton"+nextIndex onclick="hideCollapseNext("+nextIndex+")").d-none Hide
        else
            button.btn.btn-blue(id="showNextButton"+nextIndex onclick="appendShowDetails("+settings.minionSlotsNext[nextIndex-1]+")") Show

mixin minionCostRow(minionCost,i,nextIndex)
    tr(id="minion"+i+"Row" class="collapseNext"+nextIndex)
        td.text-center
            | ##{i+1}
            br
            img(src="/images/minions/"+minionCost.name+".png" width="30" height="30")
        td(id="minion"+i+"Name")=minionCost.name
        td(id="minion"+i+"Tier")=minionCost.tier
        td(id="minion"+i+"TotalCostFront")=minionCost.totalCostText
        td(id="minion"+i+"Items")
            if minionCost.upgradeMaterials
                each material in minionCost.upgradeMaterials
                    | #{material}
                    br
        td(id="minion"+i+"NumberOfItems")
            if minionCost.upgradeQuantities
                each quantity in minionCost.upgradeQuantities
                    | #{quantity}
                    br
        td(id="minion"+i+"BazaarPrices")
            if minionCost.unitPrices
                each unitPrice in minionCost.unitPrices
                    | #{unitPrice}
                    br
        td(id="minion"+i+"TotalCost")=minionCost.totalCostText

mixin infoBox(id,type,title)
    if(type=="info")
        i.fas.fa-lg(data-toggle="modal" data-target="#"+id class="fa-info-circle")
    else if(type=="question")
        i.fas.fa-lg(data-toggle="modal" data-target="#"+id class="fa-question-circle")
    .modal.fade.infoBox(id=id tabindex="-1" role="dialog" aria-labelledby=id+"Label" aria-hidden="true")
        .modal-dialog(role="document" class=(type=="rightInfo"?"modal-xl":undefined))
            .modal-content
                .modal-header
                    h3.modal-title(id=id+"Label")=title
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") &times;
                .modal-body
                    if block 
                        block 
                    else
                        p Nothing to see here
                .modal-footer
                    button.btn.btn-secondary(type="button" data-dismiss="modal") Close

block content
    .container
        h1.d-inline-block Minions (Crafts)
        span &nbsp; &nbsp;
        img.d-inline-block.align-top(src="/images/minionsCost.png" width="40" height="40")
        p.d-inline-block &nbsp; &nbsp; &nbsp;
        +infoBox("minionsTitleModal","info","Minions Profit Calculator")
            //- p It calculates the profit generated by each minion.
            //- p What's so special is that it allows you to fully personalize its elements to become your own minion tier list based on your profile, which include minion tiers, form of products (even in e-block form!), whether or not diamond spreadings are equipped, and more.
            //- p It also calculates the profit based on bazaar prices directly obtained from the Hypixel API, so the prices are up-to-date.
            //- br
            //- h4 Disclaimer
            //- p As more people are using my website, I would like to explain more about how the minion profit calculator works and its limitations.
            //- p Please note that the minion profit calculator calculates based on the instantaneous price of the items sold at bazaar, so the prices may fluctuate a lot from time to time, and so do the minions profit (as we all know the economy of Skyblock is quite unstable). The "best minion" for money may not be the same some time later. I hope you all understand this uncertainty.
            //- p Overall speaking, snow minions and clay minions are the most stable for profit as their profits do not depend on the economy. If you would like to explore other relatively stable alternatives you may watch <a href="https://youtu.be/_LmqqJtsdrk"> ModernSoldier's video</a> for more advice.
        p What are the cheapest minions to level up to gain more minion slots?
        //-TEMP
        h3 Warning
        p This feature is in beta, bugs may occur.
        #overall
            .row
                #general.col-lg-6.col-12
                    br
                    h3 General
                    .form-group
                        p Minecraft Name (optional): &nbsp; 
                            input#overallProfileName.form-control(value=settings.name)
                            span &nbsp; &nbsp; 
                            +infoBox("profileModal","question","Why is my Minecraft name required?")
                            //- p If you enter your Minecraft name, it will calculate the profit based on the highest tier of the minion you have crafted. It could make the profit list more personalized and useful when finding the most profitable minions among those you have.
                            //- p Alternatively, you could uncheck this "Use Profile" box, and select the tier of the minions manually.
                        if(settings.profileNames)
                            label(for="overallProfileProfile") Profile: &nbsp;
                            select#overallProfileProfile.form-control
                                -let k=0
                                while k<settings.profileNames.length
                                    option(value=k selected=(settings.profile==k?'selected':undefined))=settings.profileNames[k]
                                    -k++;
                .col-lg-6.col-12  
                    #advanced
                        br
                        h3 Advanced
                        .form-group
                            label(for="overallBuyingMethod") Buying method in bazaar: &nbsp;
                            select#overallBuyingMethod.form-control
                                option(value="1" selected=(settings.buyingMethod==1?'selected':undefined)) Buy order
                                option(value="0" selected=(settings.buyingMethod==0?'selected':undefined)) Buy instantly
                                
                        .form-group
                            label(for="overallTax") Tax in bazaar: &nbsp; 
                                input#overallTax.form-control(type="number" value=settings.tax min="0")
                                span &nbsp; %

                        .form-group
                            input#overallShowDetails.checkbox(type="checkbox" checked=(settings.showDetails>=1 ? 'checked' : undefined))
                            label(for="overallShowDetails") &nbsp; Show All &nbsp;
            
            br
            button#overallSettings.btn(onclick="generateLink()") Apply
            br
            br

        #content
            hr
            //- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            //- //- <!-- minions1 -->
            //- <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-3541192882647315" data-ad-slot="6074503232" data-ad-format="auto" data-full-width-responsive="true"></ins>
            //- <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script>
            br
            if !minionsCost || !settings
                h1 Error
                p.lead An unexpected error has occured.
                h3 Is Hypixel API down?
                p You could check to see if <a href="https://api.hypixel.net/skyblock/bazaar">this link</a> brings you to the raw bazaar data to see if Hypixel API is down.
                p If you think it is not an API problem, you may make a bug report <a href="/contact">here</a>. Sorry for the inconvenience caused.
            else if settings.hasError
                h1 Error
                p.lead=settings.errorMsg
                h3 Is Hypixel API down?
                p You could check to see if <a href="https://api.hypixel.net/skyblock/bazaar">this link</a> brings you to the raw bazaar data to see if Hypixel API is down.
                p If you think it is not an API problem, you may make a bug report <a href="/contact">here</a>. Sorry for the inconvenience caused.
            else
                #search: .form-group
                    label(for="searchInput") Search: &nbsp;
                    input#searchInput(list="searchDatalist").form-control
                    datalist#searchDatalist
                        each minionCost in minionsCost
                            option(value=minionCost.name.substring(0,minionCost.name.lastIndexOf(" "))+" "+minionCost.tier)
                    span &nbsp; &nbsp; &nbsp;
                    button#searchButton.btn(onclick="search()") Search
                if settings.useProfile
                    h3 Profile Information
                    p Minion Crafts: #{settings.minionCrafts}
                    p Minion Slots: #{settings.minionSlots} + #{settings.communitySlots} (Community Center)
                    p Crafts to next: #{settings.minionSlotsNext[0]}
                    p Coins to next: #{settings.minionSlotsCostText[0]}
                #doubleScroll: table#minionsTable.table.table-dark.w-100
                    thead
                        tr
                            th(scope="col")
                            th(scope="col") Minion
                            th(scope="col") Tier
                            th(scope="col") Total Upgrade Cost
                            th(scope="col") Upgrade materials
                            th(scope="col") Quantity
                            th(scope="col") Unit Price (Bazaar)
                            th(scope="col") Total Upgrade Cost 

                    if (settings.showDetails==1)
                        //-show all
                        -let nextIndex = 0;
                        -let i=0;
                        while i<minionsCost.length
                            +slotRow(nextIndex,true,true)
                            while i<settings.minionSlotsNext[nextIndex]&&i<minionsCost.length
                                +minionCostRow(minionsCost[i],i,nextIndex)
                                -i++;
                            -nextIndex++;
                    else
                        //-show top 50, until next minion slot
                        -let nextIndex = 0;
                        -let i=0;
                        while i<Math.min(50,minionsCost.length)
                            +slotRow(nextIndex,true,true)
                            while i<settings.minionSlotsNext[nextIndex]&&i<minionsCost.length
                                +minionCostRow(minionsCost[i],i,nextIndex)
                                -i++;
                            -nextIndex++;
                        while nextIndex<settings.minionSlotsNext.length
                            +slotRow(nextIndex,false,false)
                            -nextIndex++;

            p: small
                | Excluding Flower Minion 
                if(settings.lastUpdatedBazaar)
                    | <br /> Last updated time of bazaar price: #{settings.lastUpdatedBazaar} UTC
                if(settings.lastUpdatedProfile)
                    | <br /> Last updated time of profile: #{settings.lastUpdatedProfile} UTC